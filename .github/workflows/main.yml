name: Main CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-west-2

jobs:
  # This job runs when no specific service paths are changed
  # It's a fallback for general repository changes
  general-checks:
    name: General Repository Checks
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.head_commit.modified, 'frontend/') &&
      !contains(github.event.head_commit.modified, 'gateway/') &&
      !contains(github.event.head_commit.modified, 'product-service/') &&
      !contains(github.event.head_commit.modified, 'payment-service/') &&
      !contains(github.event.head_commit.modified, 'auth-service/') &&
      !contains(github.event.head_commit.modified, 'cart-service/') &&
      !contains(github.event.head_commit.modified, 'order-service/') &&
      !contains(github.event.head_commit.modified, 'terraform/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for sensitive files
      run: |
        echo "Checking for sensitive files..."
        if find . -name "*.key" -o -name "*.pem" -o -name "*.p12" | grep -q .; then
          echo "❌ Sensitive files found!"
          exit 1
        else
          echo "✅ No sensitive files found"
        fi

    - name: Check Docker Compose (Local Development)
      run: |
        echo "Validating Docker Compose for local development..."
        if [ -f "compose.yml" ]; then
          docker-compose config --quiet
          echo "✅ Docker Compose is valid"
        else
          echo "⚠️ No Docker Compose file found"
        fi

    - name: Repository Health Check
      run: |
        echo "## Repository Health Check Results 🔍" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ General repository structure validated" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ No sensitive files exposed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docker Compose (local dev) validated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: Specific service deployments are handled by individual service pipelines." >> $GITHUB_STEP_SUMMARY

  # Security Scanning for the entire repository
  repository-security:
    name: Repository Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
